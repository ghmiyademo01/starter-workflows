# This workflow will build and push an application to a Azure Kubernetes Service (AKS) cluster when you push your code
#
# This workflow assumes you have already created the target AKS cluster and have created an Azure Container Registry (ACR)
# The ACR should be attached to the AKS cluster
# For instructions see:
#   - https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough-portal
#   - https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-portal
#   - https://learn.microsoft.com/en-us/azure/aks/cluster-container-registry-integration?tabs=azure-cli#configure-acr-integration-for-existing-aks-clusters
#   - https://github.com/Azure/aks-create-action
#
# To configure this workflow:
#
# 1. Set the following secrets in your repository (instructions for getting these can be found at https://docs.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-cli%2Clinux):
#    - AZURE_CLIENT_ID
#    - AZURE_TENANT_ID
#    - AZURE_SUBSCRIPTION_ID
#
# 2. Set the following environment variables (or replace the values below):
#    - AZURE_CONTAINER_REGISTRY (name of your container registry / ACR)
#    - RESOURCE_GROUP (where your cluster is deployed)
#    - CLUSTER_NAME (name of your AKS cluster)
#    - CONTAINER_NAME (name of the container image you would like to push up to your ACR)
#    - IMAGE_PULL_SECRET_NAME (name of the ImagePullSecret that will be created to pull your ACR image)
#    - DEPLOYMENT_MANIFEST_PATH (path to the manifest yaml for your deployment)
#
# For more information on GitHub Actions for Azure, refer to https://github.com/Azure/Actions
# For more samples to get started with GitHub Action workflows to deploy to Azure, refer to https://github.com/Azure/actions-workflow-samples
# For more options with the actions used below please refer to https://github.com/Azure/login

name: Build and Deploy to AKS

on:
  push:
    branches: [ "main" ]
    paths:
      - "Dockerfile"
      - "**/*.csproj"
      - "**/*.sln"
      - "src/**"
      - "app/**"
      - "k8s/**"
      - ".github/workflows/azure-kubernetes-service.yml"
  workflow_dispatch:

# ========================
# ▼ 環境変数（要調整）
# ========================
env:
  # ACR の“名前のみ”（小文字・FQDN や .azurecr.io は含めない）
  AZURE_CONTAINER_REGISTRY: githubtestcontainer        # 例: githubtestcontainer

  # ACR 内のリポジトリ名（小文字推奨）
  CONTAINER_REPOSITORY: sampleapp                      # 例: sampleapp

  # AKS / RG
  RESOURCE_GROUP: testMiyaGroup                        # 例: testMiyaGroup
  CLUSTER_NAME: gitHubTest                             # 例: gitHubTest（実リソース名に合わせて）

  # Kubernetes（デプロイ先の論理名）
  K8S_NAMESPACE: default                               # 例: default
  DEPLOYMENT_NAME: sampleapp                           # kubectl set image で更新する Deployment 名
  CONTAINER_NAME: sampleapp                            # Deployment 内のコンテナ名

  # 便利変数（自動）
  ACR_LOGIN_SERVER: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1.4.6
        with:
          # 事前にリポジトリの Secrets に AZURE_CREDENTIALS を登録しておく
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Show ACR info (debug)
        run: |
          echo "ACR (name): $AZURE_CONTAINER_REGISTRY"
          az acr show -n "$AZURE_CONTAINER_REGISTRY" -o table

      # -----------------------------
      # Dockerfile が直下にある想定
      # 別ディレクトリなら:
      #   --file app/Dockerfile app
      # に変更してください（ビルドコンテキストも app に）
      # -----------------------------
      - name: Build image on ACR (az acr build)
        run: |
          # --image は repository:tag のみ（FQDN なし・小文字）
          az acr build \
            --registry "$AZURE_CONTAINER_REGISTRY" \
            --image "${CONTAINER_REPOSITORY}:${GITHUB_SHA}" \
            --file Dockerfile \
            .

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.RESOURCE_GROUP }}
          cluster-name: ${{ env.CLUSTER_NAME }}

      # まだ Namespace がなければ作成
      - name: Ensure namespace exists
        run: |
          kubectl get ns "$K8S_NAMESPACE" >/dev/null 2>&1 || \
          kubectl create ns "$K8S_NAMESPACE"

      # すでにマニフェストがある場合は先に apply（初回デプロイ用）
      # k8s/ 以下に deployment.yaml 等がある想定。なければスキップ。
      - name: Apply Kubernetes manifests (if present)
        run: |
          if [ -d "k8s" ]; then
            kubectl -n "$K8S_NAMESPACE" apply -f k8s/
          else
            echo "k8s/ directory not found. Skipping apply."
          fi

      # 既存 Deployment のコンテナイメージを書き換え
      - name: Update image & rollout
        run: |
          # デプロイ時は FQDN 付きの完全名を使用
          FULL_IMAGE="${ACR_LOGIN_SERVER}/${CONTAINER_REPOSITORY}:${GITHUB_SHA}"
          echo "Setting image to: $FULL_IMAGE"

          kubectl -n "$K8S_NAMESPACE" set image \
            deployment/${DEPLOYMENT_NAME} \
            ${CONTAINER_NAME}=${FULL_IMAGE}

          # ロールアウト完了待ち
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/${DEPLOYMENT_NAME} --timeout=180s

      # 参考: AKS が ACR から Pull できない場合（401 等）の対処（初回だけ実行推奨）
      # 運用では毎回実行しないでください。必要時のみ手動で有効化。
      # - name: (One-time) Attach ACR to AKS
      #   run: |
      #     ACR_ID=$(az acr show -n "$AZURE_CONTAINER_REGISTRY" --query id -o tsv)
      #     az aks update -n "$CLUSTER_NAME" -g "$RESOURCE_GROUP" --attach-acr "$ACR_ID"


      # Deploys application based on given manifest file
#      - name: Deploys application
#        uses: Azure/k8s-deploy@v4
#        with:
#          action: deploy
#          manifests: ${{ env.DEPLOYMENT_MANIFEST_PATH }}
#          images: |
#            ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME }}:${{ github.sha }}
